var _perfMainAspxResults,_perfInnerAspxResults,_perfDivIndent="&nbsp;&nbsp;&nbsp;";function OpenPerformanceUI(refresh){var mainWnd=getMainWnd(),openerWnd=window.top.opener,fullyLoadTimeExpected=!mainWnd.UseTabletExperience,innerFrame=mainWnd.document.getElementById("contentIFrame");if(!innerFrame||!innerFrame.contentWindow.PostRenderTime||fullyLoadTimeExpected&&!mainWnd.FullyLoadedTime||!mainWnd.LoadStartTime){RequestUpdate(refresh);return}if(GetPerfDiv())if(refresh)ClearPerfContent();else{ShowPerfReport(true);return}var indent=_perfDivIndent,innerWnd=innerFrame.contentWindow,isFormPage=innerWnd.location.href.indexOf("/edit.aspx")!=-1,isGridHomePage=innerWnd.location.href.indexOf("/homepage.aspx")!=-1,mainAspxMID=mainWnd.MARKERS_CACHE_ID,innerAspxMID=innerWnd.MARKERS_CACHE_ID,getPerformanceMarkersUri=Mscrm.CrmUri.create("/Tools/Diagnostics/diag.aspx").toString()+"/GetPerformanceMarkers";_perfMainAspxResults=getJson(getPerformanceMarkersUri,"{'markersCacheId':'"+mainAspxMID+"'}");_perfInnerAspxResults=getJson(getPerformanceMarkersUri,"{'markersCacheId':'"+innerAspxMID+"'}");var perfDiv=CreatePerfReportDiv(),loadStartTime=mainWnd.LoadStartTime;AddToPerfContent("<h3>Performance results</h3>");if(isFormPage){!mainWnd.InitActionQueueCompletedTime&&RequestUpdate(true);if(mainWnd.AfterWindowOpenTimestamp&&mainWnd.BeforeWindowOpenTimestamp){var windowOpenOverhead=mainWnd.AfterWindowOpenTimestamp-mainWnd.BeforeWindowOpenTimestamp;loadStartTime=mainWnd.BeforeWindowOpenTimestamp;AddToPerfContent("Time to open the window:\t"+windowOpenOverhead+" ms<br/>")}else mainWnd.opener&&RequestUpdate(true);AddToPerfContent("Server side execution info:<br/>");AddToPerfContent(indent+"Main.aspx server queuing time:\t"+(_perfMainAspxResults.HttpContextTimestamp-_perfMainAspxResults.RequestArrivalTime)+" ms<br/>");AddToPerfContent(indent+"Main.aspx server exec time:\t"+(_perfMainAspxResults.OnEndRequest-_perfMainAspxResults.HttpContextTimestamp)+" ms<br/>");AddToPerfContent(indent+"Edit.aspx server queuing time:\t"+(_perfInnerAspxResults.HttpContextTimestamp-_perfInnerAspxResults.RequestArrivalTime)+" ms<br/>");AddToPerfContent(indent+"Edit.aspx server exec time:\t"+(_perfInnerAspxResults.OnEndRequest-_perfInnerAspxResults.HttpContextTimestamp)+" ms<br/>");var timeToGetEditAspx=0,hasOpenerWnd=false;try{openerWnd.document;hasOpenerWnd=true}catch(e){}hasOpenerWnd&&openerWnd.PreloadStartTime&&openerWnd.PreloadEndTime&&AddToPerfContent("Time to preload Edit.aspx:\t"+(openerWnd.PreloadEndTime-openerWnd.PreloadStartTime)+" ms<br/>");var plt=innerWnd.PostRenderTime;if(innerWnd.PerceivedLoadTime)plt=innerWnd.PerceivedLoadTime;var pltError=0;if(innerWnd.PerceivedLoadPreRenderTime){pltError=Math.abs(innerWnd.PerceivedLoadTime-innerWnd.PerceivedLoadPreRenderTime)/2;plt-=pltError}AddToPerfContent("Perceived Load Time (read/scroll ready):\t"+(plt-loadStartTime)+" ms<br/>");pltError>0&&AddToPerfContent(indent+"Potential calculation error:\t&plusmn; "+pltError+" ms<br/>");AddToPerfContent("Full Load Time (edit ready):\t"+(mainWnd.FullyLoadedTime-loadStartTime)+" ms<br/>")}else if(isGridHomePage){!innerWnd.InitActionQueueCompletedTime&&RequestUpdate(true);loadStartTime=mainWnd.NavBarClickTime;AddToPerfContent("Perceived Load Time:\t"+(innerWnd.PostRenderTime-loadStartTime)+" ms<br/>");if(_perfInnerAspxResults){var queuingTime=_perfInnerAspxResults.HttpContextTimestamp-_perfInnerAspxResults.RequestArrivalTime;queuingTime>0&&AddToPerfContent(indent+"Grid request server queuing time:\t"+queuingTime+" ms<br/>");AddToPerfContent(indent+"Grid request server exec time:\t"+(_perfInnerAspxResults.OnEndRequest-_perfInnerAspxResults.HttpContextTimestamp)+" ms<br/>")}mainWnd.FullyLoadedTime&&AddToPerfContent("Full Load Time:\t"+(mainWnd.FullyLoadedTime-loadStartTime)+" ms<br/>")}if(mainWnd._actionQueuePerfMarkers&&mainWnd._actionQueuePerfMarkers.length>0){AddToPerfContent("<br/>");AddToPerfContent("Action Queue execution info:<br/>");AddActionQueuePerfInfoToContent(mainWnd,loadStartTime)}if(innerWnd._actionQueuePerfMarkers&&innerWnd._actionQueuePerfMarkers.length>0){AddToPerfContent("<br/>");AddToPerfContent("Action Queue execution info (inner frame):<br/>");AddActionQueuePerfInfoToContent(innerWnd,loadStartTime)}AddToPerfContent("<br/>")}function AddActionQueuePerfInfoToContent(wnd,loadStartTime){var actionQueuePerfMarkers=wnd._actionQueuePerfMarkers,actionQueueInfoHtml="";actionQueueInfoHtml+="<div style='height:100px;overflow-y:scroll;border-style:solid;border-width:1px;background-color:#ddd;'>";for(var i=0;i<actionQueuePerfMarkers.length;i++){var actionTimingInfo=actionQueuePerfMarkers[i],totalTime=actionTimingInfo.endTime-actionTimingInfo.startTime;if(totalTime>0)actionQueueInfoHtml+=_perfDivIndent+actionTimingInfo.name+":\t"+totalTime+" ms<br/>"}actionQueueInfoHtml+="</div>";AddToPerfContent(actionQueueInfoHtml);wnd.InitActionQueueCompletedTime&&AddToPerfContent("Total Init Queue Time:\t"+(wnd.InitActionQueueCompletedTime-loadStartTime)+" ms<br/>")}var _maxPerfAutoUpdates=100,_totalPerfAutoUpdates=0,_lastRequestTime=0;function RequestUpdate(refresh){if((new Date).getTime()-_lastRequestTime<=20)return;_lastRequestTime=(new Date).getTime();if(_totalPerfAutoUpdates<=_maxPerfAutoUpdates){_totalPerfAutoUpdates++;window.setTimeout(function(){OpenPerformanceUI(refresh)},100)}}function GetPerfDiv(){return getMainWnd().document.getElementById("perfDiv")}function CreatePerfReportDiv(){if(GetPerfDiv())return;var mainWnd=getMainWnd(),perfDiv=mainWnd.document.createElement("div");perfDiv.setAttribute("id","perfDiv");perfDiv.style.top=0;perfDiv.style.background="#AABBCC";perfDiv.style.border="1px solid #000";perfDiv.style.zIndex=500;var perfUpperActions=mainWnd.document.createElement("div");perfUpperActions.setAttribute("id","perfUpperActions");perfUpperActions.style.textAlign="right";perfDiv.appendChild(perfUpperActions);var perfInnerContent=mainWnd.document.createElement("div");perfInnerContent.setAttribute("id","perfInnerContent");perfDiv.appendChild(perfInnerContent);var perfInnerActions=mainWnd.document.createElement("div");perfInnerActions.setAttribute("id","perfInnerActions");perfDiv.appendChild(perfInnerActions);mainWnd.document.body.appendChild(perfDiv);ShowPerfReport(true);$addHandler(window,"unload",DisposePerfReportDiv);return perfDiv}function DisposePerfReportDiv(){$removeHandler(window,"unload",DisposePerfReportDiv);var mainWnd=getMainWnd(),perfDiv=mainWnd.document.getElementById("perfDiv");mainWnd.document.body.removeChild(perfDiv)}function RegisterEventHandlers(){var mainWnd=getMainWnd(),crmTopBar=mainWnd.document.getElementById("crmTopBar");if(crmTopBar){crmTopBar.addEventListener("touchstart",_PerfTouchStart,false);crmTopBar.addEventListener("touchmove",_PerfTouchMove,false);crmTopBar.addEventListener("touchend",_PerfTouchEnd,false)}mainWnd.$addHandler(mainWnd.document,"keyup",_PerfKeyUpHandler);$addHandler(window.document,"keyup",_PerfKeyUpHandler);$addHandler(window,"beforeunload",UnregisterEventHandlers)}function UnregisterEventHandlers(){var mainWnd=getMainWnd(),crmTopBar=mainWnd.document.getElementById("crmTopBar");if(crmTopBar){crmTopBar.removeEventListener("touchstart",_PerfTouchStart,false);crmTopBar.removeEventListener("touchmove",_PerfTouchMove,false);crmTopBar.removeEventListener("touchend",_PerfTouchEnd,false)}mainWnd.$removeHandler(mainWnd.document,"keyup",_PerfKeyUpHandler);$removeHandler(window.document,"keyup",_PerfKeyUpHandler);$removeHandler(window,"beforeunload",UnregisterEventHandlers)}RegisterEventHandlers();function _PerfKeyUpHandler(event){event.keyCode==81&&event.ctrlKey&&event.shiftKey&&OpenPerformanceUI()}var _perfTouchStartX=0,_perfTouchCurrentX=0,_perfTouchSwipeThreshold=50;function _PerfTouchStart(event){if(event.touches){var touch=event.touches[0];if(touch)_perfTouchStartX=touch.pageX}}function _PerfTouchMove(event){if(event.touches){var touch=event.touches[0];if(touch)_perfTouchCurrentX=touch.pageX}}function _PerfTouchEnd(event){if(_perfTouchCurrentX<=0)return;var swipeLength=Math.abs(_perfTouchCurrentX-_perfTouchStartX);swipeLength>_perfTouchSwipeThreshold&&OpenPerformanceUI();_perfTouchStartX=0;_perfTouchCurrentX=0}function AddToPerfContent(str){var mainWnd=getMainWnd(),perfInnerContent=mainWnd.document.getElementById("perfInnerContent");perfInnerContent.innerHTML+=str}function ClearPerfContent(){var mainWnd=getMainWnd(),perfInnerContent=mainWnd.document.getElementById("perfInnerContent");perfInnerContent.innerHTML=""}function ShowPerfReport(show){var mainWnd=getMainWnd(),perfDiv=mainWnd.document.getElementById("perfDiv"),perfUpperActions=mainWnd.document.getElementById("perfUpperActions"),perfInnerContent=mainWnd.document.getElementById("perfInnerContent"),perfInnerActions=mainWnd.document.getElementById("perfInnerActions"),openDivWidth=400,hiddenDivWidth=60,padding=10;if(show){perfDiv.style.width=openDivWidth+"px";perfDiv.style.height="auto";perfDiv.style.position="absolute";perfDiv.style.left="50%";perfDiv.style.marginLeft=-(openDivWidth/2)+"px";perfDiv.style.padding=padding+"px";perfDiv.style.paddingTop=0+"px";perfInnerContent.style.display="block";perfInnerActions.style.display="block";perfUpperActions.innerHTML="<font color='blue'><a href='#' onclick='window.document.getElementById(\"contentIFrame\").contentWindow.ShowPerfReport(false)'><u>hide</u></a></font>";if(window.clipboardData){perfInnerActions.innerHTML="<font color='blue'>";perfInnerActions.innerHTML+="<a href='#' onclick='window.document.getElementById(\"contentIFrame\").contentWindow.copyPerfResults()'><u>copy</u></a>";perfInnerActions.innerHTML+="&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";perfInnerActions.innerHTML+="<a href='#' onclick='window.document.getElementById(\"contentIFrame\").contentWindow.copyPerfReport()'><u>copy report</u></a>";perfInnerActions.innerHTML+="</font>"}}else{perfDiv.style.width=hiddenDivWidth+"px";perfDiv.style.height="18px";perfDiv.style.position="absolute";perfDiv.style.left="50%";perfDiv.style.marginLeft=openDivWidth/2-hiddenDivWidth+"px";perfDiv.style.paddingBottom=0+"px";perfInnerContent.style.display="none";perfInnerActions.style.display="none";perfUpperActions.innerHTML="Perf: <font color='blue'><a href='#' onclick='window.document.getElementById(\"contentIFrame\").contentWindow.ShowPerfReport(true)'><u>show</u></a>"}}function GetPerfResultsText(){var mainWnd=getMainWnd(),perfInnerContent=mainWnd.document.getElementById("perfInnerContent");if(perfInnerContent)return perfInnerContent.innerText}function BuildPerfResultsReport(perfResults){var reIndent=/    /g,reSeparator=/: /g,reMs=/ ms/g;perfResults=perfResults.replace(reIndent,"");perfResults=perfResults.replace(reSeparator,"\t");perfResults=perfResults.replace(reMs,"");return perfResults}function BuildPerfMarkersReport(){var aMarkers=[];AddTimingValue(aMarkers,"getMainWnd().AfterWindowOpenTimestamp");AddTimingValue(aMarkers,"getMainWnd().BeforeWindowOpenTimestamp");AddTimingValue(aMarkers,"getMainWnd().LoadStartTime");AddTimingValue(aMarkers,"getMainWnd().BeforePerceivedRibbonRenderingTimestamp");AddTimingValue(aMarkers,"getMainWnd().AfterPerceivedRibbonRenderingTimestamp");AddTimingValue(aMarkers,"getMainWnd().InnerIFrameSrcChangeTimestamp");AddTimingValue(aMarkers,"getMainWnd().FullyLoadedTime");AddTimingValue(aMarkers,"getMainWnd().PostRenderTime");AddTimingValue(aMarkers,"getMainWnd().StartLoadContentPanel");AddTimingValue(aMarkers,"getMainWnd().PreLoadContentPageWaitTimeout");AddTimingValue(aMarkers,"getOpenerWnd().PreloadStartTime");AddTimingValue(aMarkers,"getOpenerWnd().PreloadEndTime");AddTimingValue(aMarkers,"_perfMainAspxResults.OnEndRequest");AddTimingValue(aMarkers,"_perfMainAspxResults.RequestArrivalTime");AddTimingValue(aMarkers,"_perfMainAspxResults.HttpContextTimestamp");AddTimingValue(aMarkers,"_perfInnerAspxResults.OnEndRequest");AddTimingValue(aMarkers,"_perfInnerAspxResults.RequestArrivalTime");AddTimingValue(aMarkers,"_perfInnerAspxResults.HttpContextTimestamp");AddTimingValue(aMarkers,"getInnerWnd().LoadStartTime");AddTimingValue(aMarkers,"getInnerWnd().PostRenderTime");for(var perfMarkers="",i=0;i<aMarkers.length;i++)perfMarkers+=aMarkers[i].name+"\t"+aMarkers[i].value+"\n";return perfMarkers}function AddTimingValue(aMarkers,sTimeMarker){try{var sValue=eval(sTimeMarker);typeof sValue!="undefined"&&aMarkers.push({name:sTimeMarker,value:sValue})}catch(e){}}function getMainWnd(){var mainWnd=window;if(window!=window.top)mainWnd=window.top;return mainWnd}function getInnerWnd(){var mainWnd=getMainWnd(),innerFrame=mainWnd.document.getElementById("contentIFrame");if(innerFrame!=null)return innerFrame.contentWindow}function getOpenerWnd(){return window.top.opener}function copyPerfResults(){window.clipboardData&&window.clipboardData.setData("Text",GetPerfResultsText())}function copyPerfReport(){var perfMarkers=BuildPerfMarkersReport(),perfResults=BuildPerfResultsReport(GetPerfResultsText());window.clipboardData&&window.clipboardData.setData("Text",perfMarkers+"\n\n"+perfResults)}function closePerfResults(){var perfDiv=getMainWnd().document.getElementById("perfDiv");if(perfDiv)if(perfDiv.style.visibility==="hidden")perfDiv.style.visibility="show";else perfDiv.style.visibility="hidden"}function getJson(url,args){var res=null;try{var mainWnd=getMainWnd(),_perfXmlhttp=new mainWnd.XMLHttpRequest;_perfXmlhttp.open("POST",url,false);_perfXmlhttp.setRequestHeader("content-type","application/json; charset=utf-8");_perfXmlhttp.setRequestHeader("cache-control","no-cache");_perfXmlhttp.send(args);if(_perfXmlhttp.readyState==4&&_perfXmlhttp.status==200)try{res=(eval("("+_perfXmlhttp.responseText+")")).d}catch(e){res=e.Message}}catch(e){}return res}